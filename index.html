<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CALCOLO MOTIVICO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.js"></script>
    <script src="https://cdn.rawgit.com/davidedc/Algebrite/master/dist/algebrite.bundle-for-browser.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
</head>
<body><h1>Computation of motives given &Omega;<sub>i</sub></h1>
    <p> Currently, given the known  &Omega;<sub>i</sub>, the program computes the motives as far as possible. It is possible to check product factors by clicking the button to the right of each input box.</p>
    <div id="output"></div> 
      
      
    <script>
        var output = document.getElementById('output'); 
        function creaCaselleInput() {
            let n = parseInt(prompt("Enter the number of Ωi you know"));
          
            let body = document.getElementsByTagName("body")[0];
          
            function createInputFields() {
                output.innerHTML = ''; // Pulisce l'output precedente
              let containers = document.querySelectorAll(".inputContainer");
              containers.forEach(container => container.remove()); // Rimuove i container precedenti
               
              for (let i = 1; i <= n; i++) {
                let container = document.createElement("div");
                container.setAttribute("class", "inputContainer");
                container.setAttribute("style", "margin-bottom: 5px;");
          
                let input = document.createElement("input");
                input.setAttribute("type", "text");
                input.setAttribute("id", "input_" + i);
                input.setAttribute("value", i);
                input.setAttribute("style", "margin-left: 5px;margin-right: 5px; "); 
                const screenWidth = window.innerWidth;
                const seventyFivePercentScreenWidth = screenWidth * 0.3;
                
                input.style.width = `${seventyFivePercentScreenWidth}px`; 
          
                let omegaText = document.createElement("span");
                omegaText.innerHTML = "&Omega;<sub>" + i + "</sub>  ";
                omegaText.setAttribute("style", "margin-left: 5px;");
          
                let output = document.createElement("span");
                output.setAttribute("id", "output_" + i);
                output.setAttribute("style", "margin-left: 10px;");
          
                let button = document.createElement("button");
                button.textContent = "Factor " + i;
                button.setAttribute("type", "button");
          
                button.addEventListener("click", function() {
                  mostraValori(i);
                });
          
                container.appendChild(omegaText);
                container.appendChild(input);
                container.appendChild(button);
                container.appendChild(output);
                body.appendChild(container);
              }
          
              let buttonsContainer = document.createElement("div");
              buttonsContainer.setAttribute("class", "buttonsContainer");
          
              let mostraValoriButton = document.createElement("button");
              mostraValoriButton.textContent = "Motives";
              mostraValoriButton.setAttribute("type", "button");
              mostraValoriButton.setAttribute("style", "margin-right: 5px;");
          
              mostraValoriButton.addEventListener("click", function() {
                var fatto = finale(parseInt(document.getElementsByTagName("input").length-3)); // Valore predefinito '1'
                output.innerHTML += "<p> <b> Motives:</b> "   +  fatto  +"</p>"; 
                output.innerHTML += "<p><b> Euler characteristics:</b> "   +  serieCaratt(fatto.toString())  +"</p>"; 
              });
          
              buttonsContainer.appendChild(mostraValoriButton);
          
              let setP2 = document.createElement("button");
              setP2.innerHTML = '(<span style="font-family: Arial, sans-serif;">&#8473;</span><sup>2</sup>)<sup>[n]</sup><sub>0</sub>';

              setP2.setAttribute("type", "button");
              setP2.setAttribute("style", "margin-right: 5px;");
          
              setP2.addEventListener("click", function() { 
                buttonsContainer.remove();
                
                n = parseInt(prompt("How many terms do you need?"));
                createInputFields();
                document.getElementById("input_1").setAttribute("value", "1");
                for (var i = 2 ; i<=n ;i++){
                document.getElementById("input_"+i).setAttribute("value", "L^"+ math.simplify(i-1));
                }
              });
          
              buttonsContainer.appendChild(setP2);
                    
              let setToZeroButton = document.createElement("button");
              setToZeroButton.innerHTML = '(<span style="font-family: Arial, sans-serif;">&#8473;</span><sup>3</sup>)<sup>[n]</sup><sub>0</sub>';
  
              setToZeroButton.setAttribute("type", "button");
              setToZeroButton.setAttribute("style", "margin-right: 5px;");
          
              setToZeroButton.addEventListener("click", function() { 
                buttonsContainer.remove();
                n = 6;
                createInputFields();
                document.getElementById("input_1").setAttribute("value", "1");
                document.getElementById("input_2").setAttribute("value", "L+L^2");
                document.getElementById("input_3").setAttribute("value", "L^2+L^3+L^4");
                document.getElementById("input_4").setAttribute("value", "L^6 + 2*L^5 + L^4 + L^3 - L^2");
                document.getElementById("input_5").setAttribute("value", "L^8 + 2*L^7 + 2*L^6 + L^5 - L^3");  
                document.getElementById("input_6").setAttribute("value", "L^10 + 3*L^9 + 4*L^8 + 3*L^7 - L^6 - 2*L^5 - 2*L^4"); 
                
              });
              buttonsContainer.appendChild(setToZeroButton);
                      
            body.appendChild(buttonsContainer);
            let texto = document.createElement("span");
            texto.innerHTML = "<b>Insert the motive of the variety: </b> ";
            texto.setAttribute("style", "margin-left: 5px;");

            let varietyContainer = document.createElement("div");
            varietyContainer.setAttribute("class", "inputContainer");
            let inputa = document.createElement("input");
            inputa.setAttribute("type", "text");
            inputa.setAttribute("id", "variety");
            inputa.setAttribute("value", 1);
            inputa.setAttribute("style", "margin-top: 5px;margin-right: 5px; ");
            let moltiplica = document.createElement("button");
            moltiplica.setAttribute("type", "button");
            moltiplica.setAttribute("id", "buttvariety");
            moltiplica.textContent = "Global motive";
            moltiplica.setAttribute("style", "margin-top: 5px;margin-right: 5px; "); 
            moltiplica.addEventListener("click", function() {   
                for (var i = 1 ; i<=n ;i++){
                    console.log(n);
                    var fatto = "("+ document.getElementById("input_"+i).value +")*("+ inputa.value +")"
                document.getElementById("input_"+i).setAttribute("value", fatto);
                }
              });
              let Pn = document.createElement("button");
              Pn.innerHTML = ' <span style="font-family: Arial, sans-serif;">&#8473;</span><sup>n</sup>';
              Pn.setAttribute("id", "Pn");
              Pn.setAttribute("type", "button");
              Pn.setAttribute("style", "margin-right: 5px;");
              let inputPn = document.createElement("input");
              inputPn.setAttribute("type", "text");
              inputPn.setAttribute("id", "inputPn");
              inputPn.setAttribute("placeholder", "n");
              inputPn.setAttribute("style", "margin-top: 5px;margin-right: 5px;width: 30px; ");
          
              Pn.addEventListener("click", function() {   
                s=math.parse(inputPn.value);
                if(inputPn.value){
                    var proiettivo = '1';
                    for (var i = 1 ; i<=s ; i++ )
                    proiettivo += "+L^" + i ;
                }
                inputa.setAttribute("value", proiettivo);
              }); 

            varietyContainer.appendChild(texto);
            varietyContainer.appendChild(inputa);
            varietyContainer.appendChild(moltiplica);
            varietyContainer.appendChild(Pn);
            varietyContainer.appendChild(inputPn);
            body.appendChild(varietyContainer);


              
            let newomegaContainer = document.createElement("div");
            newomegaContainer.setAttribute("class", "inputContainer");

            let testo = document.createElement("span");
            testo.innerHTML = "<b>Insert the "+ math.simplify(n+1) +"-th motive: </b> ";
            testo.setAttribute("style", "margin-left: 5px;");

            let newMotive = document.createElement("input");
            newMotive.setAttribute("type", "text");
            newMotive.setAttribute("id", "newMotive");
            newMotive.setAttribute("value", 1);
            newMotive.setAttribute("style", "margin-top: 5px;margin-right: 5px; ");

            let outputnewMotive = document.createElement("span");
            outputnewMotive.setAttribute("id", "outputnewMotive");
            outputnewMotive.setAttribute("style", "margin-left: 10px;");
          

            let calcolanewMotive = document.createElement("button");
            calcolanewMotive.setAttribute("type", "button");
            calcolanewMotive.setAttribute("id", "calcolanewMotive");
            calcolanewMotive.textContent = "Compute Ω"+math.simplify(n+1);
            calcolanewMotive.setAttribute("style", "margin-top: 5px;margin-right: 5px; "); 
            calcolanewMotive.addEventListener("click", function() { 
                var b = parseInt(document.getElementsByTagName("input").length-2);
                var rifatto = Algebrite.expand( '(' +finale(b).toString()+ ')*(1+a*t^'+ b +')'); // Valore predefinito '1'
                outputnewMotive.innerHTML += "<p>"   +  rifatto  +"</p>";
                
                
              });

              newomegaContainer.appendChild(testo);
              newomegaContainer.appendChild(newMotive);
              newomegaContainer.appendChild(calcolanewMotive);
              newomegaContainer.appendChild(outputnewMotive);
            body.appendChild(newomegaContainer);

          }

            createInputFields(); // Chiamata iniziale per creare i campi di input
          }
         
        function mostraValori(h) {
            let inputId = "input_" + h;
            let outputId = "output_" + h; // Modifica per far riferimento all'ID unico dell'output
            let outputElement = document.getElementById(outputId); // Modifica per selezionare l'elemento di output corretto
        
            if (outputElement) {
                let inputElement = document.getElementById(inputId);
                if (inputElement) {
                    let valoreInput = Algebrite.expand(inputElement.value).toString(); 
                    
                    outputElement.innerText =  sviluppoProdotto( math.parse(valoreInput),h+1,parseInt(document.getElementsByTagName("input").length-2)) ; // Mostra il valore dell'input nell'output
                } else {
                    console.log("Elemento con ID " + inputId + " non trovato");
                    outputElement.innerText += "2errore2"; // Se l'elemento di input non è trovato, aggiungi "2ciao2" all'output
                }
            } else {
                console.log("Elemento con ID " + outputId + " non trovato");
            }}
         
            
        	function sviluppoMonomio(p,n){
                var output = document.getElementById("output");
                        var t = math.parse('t');
                        var sviluppo = math.parse('0');
                            for (var i = 0; i < n; i++) {
                        var termine = math.simplify(math.parse('(((' + p.toString() + ')*t)^'+i+')'));
                        console.log(i.toString()+ "e" +termine.toString());
                        sviluppo = sviluppo +'+'+ '(' + termine.toString() + ')';
                        svuluppo = Algebrite.expand( sviluppo.toString() ).toString() ;
                            } 
                        var espansione = Algebrite.expand( sviluppo.toString() );  
                        return espansione;
                    }
                
            function sviluppoProdotto(p,a,n){
                var l =math.simplify(math.parse(a + "-" + "1"));   
                    
                if (p !== null) {
                    var completo = 1;                    
                    for (var i = 0; i < parseInt(degreePolynomial(p ))+1 ; i++) {
                        console.log('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%' );
                        var GIUSU = estraiTermine(p,i, 'L').split("*"); 
                        var GIU = math.simplify(GIUSU[1]); 
                        var temp = Algebrite.expand('(' + (Algebrite.expand( sviluppoMonomio(GIU,parseInt(((n+1)/(a-1))+1) ))).toString() + ')^'+GIUSU[0]).toString() ; 
                        completo =      Algebrite.expand( truncate(  '(' + completo.toString() + ')*(' + temp + ')'  ,n ) );  
                }
                var  funzione = truncate(completo.toString(),n); 
                var result =   truncate(Algebrite.expand(funzione.toString().replace(/t/g, "(t^" +l+" )").replace(/\+\s+-/g, "-")),n-1) ;  
                return  result ;
                                 
                }
            } 
            //.replace(/\+\s+-/g, "-") 
            function estraiTermine(p, n , variable) {
                var L=math.parse(variable);
                var node = p;
                var grado = parseInt(n);
                var der = nthDerivative(node, grado , variable).evaluate({ [variable] : 0 }) / fattoriale(grado);
                
                var fattore = math.simplify(math.parse('((' + der + '))*' + variable + '^' + grado.toString()));
                var stringa = fattore .toString().replace(")",'').replace("(",'');
                  if (stringa.startsWith('L')) { 
                    console.log("a");
                    return "(1)*" + stringa; 
                } else if (stringa.startsWith('-')&stringa.indexOf('L') !== -1) { 
                    if (stringa.indexOf('*') === -1){
                        console.log("b");
                        return "1*(" +stringa + ")";
                    }
                    else{
                        console.log("c");
                        return stringa.split("*")[0].replace(/-/,'') + "* (- "+ stringa.split("*")[1] +")";
                    }
              }else if (stringa.indexOf('L') === -1) { 
                console.log("d","(" + stringa + ")" + "* (1)");
                    return "(" + stringa + ")" + "* (1)";
              } else { 
                console.log("e");
                    return stringa;
        }}
                
                
                
                
                function nthDerivative(f, n , a) {
                        var result =  f;
                        for (var i = 0; i < n; i++) {
                            result = math.derivative(result, a);
                        }
                        return result;
                        }
                
                
                function fattoriale(n) {
                    if (n === 0 || n === 1) {
                        return 1;
                    } 
                    else {
                        return math.multiply(n, fattoriale(n - 1));
                        }
                    }

                    function degreePolynomial(p) {
                        var stringa=p.toString();
                        stringa = stringa.replace(/\s/g, ''); // Rimuove tutti gli spazi dalla stringa
                    
                        let regex = /\^(\d+)/g;
                        let matches = stringa.match(regex);
                        let matches2 = stringa.match('L'); // Trova tutte le corrispondenze nella stringa senza spazi
                    
                        let massimoA = 0;
                    
                        if (matches) {
                            matches.forEach(match => {
                                let numeroA = parseInt(match.substring(1)); // Estrai il valore di 'a' dalla corrispondenza
                                massimoA = Math.max(massimoA, numeroA); // Aggiorna il massimo valore di 'a' trovato finora
                            });
                        }
                        else if(matches2){massimoA=1}
                    
                        return massimoA;
                    }
                    
                    

                    
                function truncate(p, n) {
                    var stringa = Algebrite.expand(p.toString()).toString();
                    const regex = /t\^(\d+)/g;
                    let match;
                    let minExponent = Number.MAX_SAFE_INTEGER;
                    let minExponentIndex = -1;
                
                    while ((match = regex.exec(stringa)) !== null) {
                        const exponent = parseInt(match[1]);
                        if (exponent > n && exponent < minExponent) {
                            minExponent = exponent;
                            minExponentIndex = match.index;
                        }
                    }
                
                    if (minExponentIndex !== -1) {
                        const indexT = stringa.lastIndexOf('t', minExponentIndex); // Ultimo 't' prima dell'occorrenza trovata
                        const firstPart = stringa.substring(0, indexT); // Parte della stringa prima dell'occorrenza
                        const secondPart = stringa.substring(indexT); // Parte della stringa dall'occorrenza in poi
                
                     const indicePiu =  secondPart.indexOf('+') ; 
                  if (indicePiu !== -1) {
                    
                    return Algebrite.expand(secondPart.substring( indicePiu+1));
                  } 
                else {
                    return "Il carattere '+' non è presente nella stringa.";
                  }
                    }
                    
                    // Se non c'è nessuna corrispondenza o 't^a' con esponente minore di n, restituisci la stringa originale
                    return p;
                
                
                }
                
 
    
    function finale(n){
        output.innerHTML = ''; // Pulisce l'output precedente
        var stringa = "1";
        for(var h = n ; h>=1 ; h-- ){ 
           let inputId = "input_" + h.toString();
            let outputId = "output_" + h.toString(); // Modifica per far riferimento all'ID unico dell'output
            let outputElement = document.getElementById(outputId); // Modifica per selezionare l'elemento di output corretto
        
            if (outputElement) {
                let inputElement = document.getElementById(inputId);
                if (inputElement) {
                    let valoreInput = Algebrite.expand(inputElement.value).toString(); 
                    stringa += "*(" + sviluppoProdotto(math.parse(valoreInput),h+1,n+1)+")"; 
                    stringa =  "(" + truncate( Algebrite.expand(stringa) ,n).toString()+")";
                } else {
                    console.log("Elemento con ID " + inputId + " non trovato");
                    output.innerText += "2errore2"; // Se l'elemento di input non è trovato, aggiungi "2ciao2" all'output
                }
            } else {
                console.log("Elemento con ID " + outputId + " non trovato");
            }
        } 
        var result = truncate( Algebrite.expand(stringa) ,n); 
        return result;
    }
    function serieCaratt(p){
        var result = p.replace(/L/g, "1");
        return result =  Algebrite.expand(result).toString();
    } 
    function nuovoOmega(){
        
    }
        window.onload = creaCaselleInput;
        
    </script>
</body>
</html>
